##### 2024-05-08 Spring Security ìˆ˜ì—…ë‚´ìš©2

# Spring Security 3 ê°€ì§€ ì¸ì¦ ë°©ì‹
    - ì¸ë©”ëª¨ë¦¬ ì¸ì¦ ë°©ì‹
    - JDBC ì¸ì¦ ë°©ì‹
    - ì‚¬ìš©ì ì •ì˜ ì¸ì¦ ë°©ì‹

### 2. JDBC ì¸ì¦ ë°©ì‹ <br>
    JDBC ë°©ì‹ìœ¼ë¡œ ì¸ì¦í•˜ê¸° ìœ„í•´ì„œ, ë°ì´í„°ë² ì´ìŠ¤ì— ì‚¬ìš©ì í…Œì´ë¸”ê³¼ ê¶Œí•œ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    â€¢ user
    â€¢ user_auth
<br>

```sql
-- user/ ì‚¬ìš©ì(íšŒì›) í…Œì´ë¸”
CREATE TABLE `user` (
  `USER_NO` int NOT NULL AUTO_INCREMENT,
  `USER_ID` varchar(100) NOT NULL,
  `USER_PW` varchar(200) NOT NULL,
  `NAME` varchar(100) NOT NULL,
  `EMAIL` varchar(200) DEFAULT NULL,
  `REG_DATE` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `UPD_DATE` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `ENABLED` int DEFAULT 1,
  PRIMARY KEY (`USER_NO`)
) COMMENT='íšŒì›';


-- user_auth / ê¶Œí•œ í…Œì´ë¸”
CREATE TABLE `user_auth` (
      auth_no int NOT NULL AUTO_INCREMENT       -- ê¶Œí•œë²ˆí˜¸
    , user_id varchar(100) NOT NULL             -- ì•„ì´ë””
    , auth varchar(100) NOT NULL                -- ê¶Œí•œ (ROLE_USER, ROLE_ADMIN, ...)
    , PRIMARY KEY(auth_no)                      
);

-- ì‚¬ìš©ì ë° ê¶Œí•œ ê¸°ë³¸ ë°ì´í„°
-- ê¸°ë³¸ ë°ì´í„°
-- NoOpPasswordEncoder - ì•”í˜¸í™” ì—†ì´ ë¡œê·¸ì¸
-- ì‚¬ìš©ì
INSERT INTO user ( user_id, user_pw, name, email )
VALUES ( 'user', '123456', 'ì‚¬ìš©ì', 'user@mail.com' );

-- ê´€ë¦¬ì
INSERT INTO user ( user_id, user_pw, name, email )
VALUES ( 'admin', '123456', 'ê´€ë¦¬ì', 'admin@mail.com' );


-- BCryptPasswordEncoder - ì•”í˜¸í™” ì‹œ
-- ì‚¬ìš©ì
INSERT INTO user ( user_id, user_pw, name, email )
VALUES ( 'user', '$2a$12$TrN..KcVjciCiz.5Vj96YOBljeVTTGJ9AUKmtfbGpgc9hmC7BxQ92', 'ì‚¬ìš©ì', 'user@mail.com' );

-- ê´€ë¦¬ì
INSERT INTO user ( user_id, user_pw, name, email )
VALUES ( 'admin', '$2a$12$TrN..KcVjciCiz.5Vj96YOBljeVTTGJ9AUKmtfbGpgc9hmC7BxQ92', 'ê´€ë¦¬ì', 'admin@mail.com' );

-- ê¶Œí•œ
-- ì‚¬ìš©ì 
-- * ê¶Œí•œ : ROLE_USER
INSERT INTO user_auth ( user_id,  auth )
VALUES ( 'user', 'ROLE_USER' );

-- ê´€ë¦¬ì
-- * ê¶Œí•œ : ROLE_USER, ROLE_ADMIN
INSERT INTO user_auth ( user_id,  auth )
VALUES ( 'admin', 'ROLE_USER' );

INSERT INTO user_auth ( user_id,  auth )
VALUES ( 'admin', 'ROLE_ADMIN' );
```
<br>

### SecurityConfig.java ì„¤ì • <br>

```java

@EnableWebSecurity              // í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì • ë¹ˆìœ¼ë¡œ ë“±ë¡
public class SecurityConfig extends WebSecurityConfigurerAdapter {

		@Autowired
    private PasswordEncoder passwordEncoder;        // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ê°ì²´

		@Autowired
    private DataSource dataSource;          // application.properites ì— ì •ì˜í•œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê°ì²´
		
		/**
     * ğŸ‘®â€â™‚ï¸ğŸ”ì‚¬ìš©ì ì¸ì¦ ê´€ë¦¬ ë©”ì†Œë“œ
     * â­JDBC ì¸ì¦ ë°©ì‹
     * âœ… ë°ì´í„° ì†ŒìŠ¤ 
     * âœ… SQL ì¿¼ë¦¬ ë“±ë¡
     *      â­ ì‚¬ìš©ì ì¸ì¦ ì¿¼ë¦¬
     *      â­ ì‚¬ìš©ì ê¶Œí•œ ì¿¼ë¦¬
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {

        // â­ ì‚¬ìš©ì ì¸ì¦ ì¿¼ë¦¬
        String sql1 = " SELECT user_id as username, user_pw as password, enabled "
                    + " FROM user "
                    + " WHERE user_id = ? ";

        // â­ ì‚¬ìš©ì ê¶Œí•œ ì¿¼ë¦¬
        String sql2 = " SELECT user_id as username, auth " 
                    + " FROM user_auth "
                    + " WHERE user_id = ? ";

        auth.jdbcAuthentication()
            // ë°ì´í„° ì†ŒìŠ¤ ë“±ë¡
            .dataSource( dataSource )
            // ì¸ì¦ ì¿¼ë¦¬    (ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸/í™œì„±ì—¬ë¶€)
            .usersByUsernameQuery(sql1)
            // ì¸ê°€ ì¿¼ë¦¬    (ì•„ì´ë””/ê¶Œí•œ)
            .authoritiesByUsernameQuery(sql2)
            // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ë°©ì‹ ì§€ì • - BCryptPasswordEncoder ë˜ëŠ” NoOpPasswordEncoder
            .passwordEncoder( passwordEncoder );

    }

}
```

<br>

### application.properties ì†ì„± ì„¤ì • <br>

```java
# ë°ì´í„° ì†ŒìŠ¤ - MySQL
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/joeun?serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true&useSSL=false&autoReconnection=true&autoReconnection=true
spring.datasource.username=joeun
spring.datasource.password=123456
```
<br>

### 3. ì‚¬ìš©ì ì •ì˜ ì¸ì¦ ë°©ì‹ <br>
    - Mybatis ë‚˜, JPA ë“±ì˜ ë°ì´í„° ì ‘ê·¼ ë¡œì§ì„ ë¡œê·¸ì¸ ì‚¬ìš©ì ì¸ì¦ê³¼ ì—°ê²°í•˜ì—¬ ì¸ì¦ë˜ë„ë¡ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì •ì„ ì§€ì •í•˜ëŠ” ë°©ì‹ì´ë‹¤.

    - ë”°ë¼ì„œ, Mybatis ë‚˜ JPA  ë“±ìœ¼ë¡œ ì‚¬ìš©ì ì¸ì¦ ë° ê¶Œí•œ ì¡°íšŒë¥¼ ìœ„í•œ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ë¡œì§ì„ ë¨¼ì € ì‘ì„±í•œë‹¤.
<br>

### dUserMapper.xml ì„¤ì • <br>

```xml
<!-- namespace="ë§¤í¼ ì¸í„°í˜ì´ìŠ¤ ê²½ë¡œ" -->
<mapper namespace="com.joeun.springsecurity.mapper.UserMapper">

    <resultMap type="Users" id="userMap">
        <id property="userNo" column="user_no" />
        
        <result property="userNo" column="user_no" />
        <result property="userId" column="user_id" />
        <result property="userPw" column="user_pw" />
        <result property="name" column="name" />
        <result property="email" column="email" />
        <result property="enabled" column="enabled" />
        <result property="regDate" column="reg_date" />
        <result property="updDate" column="upd_date" />
        
        <collection property="authList" resultMap="authMap"></collection>
    </resultMap>
        
    <resultMap type="UserAuth" id="authMap">
        <result property="userId" column="user_id" />
        <result property="auth" column="auth" />
    </resultMap>

    <!-- íšŒì› ì¡°íšŒ - id -->
    <select id="login" resultMap="userMap">
        SELECT u.user_no
              ,u.user_id
              ,user_pw
              ,name
              ,email
              ,enabled
              ,reg_date
              ,upd_date
              ,auth
        FROM user u LEFT OUTER JOIN user_auth auth ON u.user_id = auth.user_id
        WHERE u.user_id = #{userId}
    </select>

</mapper>
```
<br>

### resultMap : SQL ì¿¼ë¦¬ì˜ ê²°ê³¼ ì§‘í•©ì„ ìë°” ê°ì²´ë¡œ ë§¤í•‘í•˜ëŠ” ë°©ë²•ì„ ì •ì˜í•˜ëŠ” XML íƒœê·¸ <br>
    â€¢ type ì†ì„±: ResultMapì´ ë§¤í•‘í•  ìë°” ê°ì²´ì˜ í´ë˜ìŠ¤ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

    â€¢ id ì†ì„±: ResultMapì˜ ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤.

```xml 
<resultMap type="íŒ¨í‚¤ì§€ëª….í´ë˜ìŠ¤ëª…" id="ì•„ì´ë””">
    <id property="PKë³€ìˆ˜ëª…" column="PKì»¬ëŸ¼ëª…" />
		<result property="ë³€ìˆ˜ëª…1" column="ì»¬ëŸ¼ëª…1" />
		<result property="ë³€ìˆ˜ëª…2" column="ì»¬ëŸ¼ëª…2" />
		...
		<collection property="ë³€ìˆ˜ëª…10" resultMap="ë§¤í•‘ëœresultMapì˜ ID"></collection>
</resultMap>
```

â€¢ id : ê°ì²´ì™€ DB ì˜ PK(ê¸°ë³¸í‚¤) ë¥¼ ì§€ì •í•˜ëŠ” íƒœê·¸
    â—¦ property : ë§¤í•‘í•  ê°ì²´ì˜ ë³€ìˆ˜ëª…
    â—¦ column : ë§¤í•‘í•  DB í…Œì´ë¸”ì˜ ì»¬ëŸ¼ëª…

â€¢ result : ë§¤í•‘í•  ê°ì²´ì˜ ë³€ìˆ˜ëª…ê³¼ DB í…Œì´ë¸”ì˜ ì»¬ëŸ¼ëª…ì„ ì§€ì •í•˜ëŠ” íƒœê·¸
    â—¦ property : ë§¤í•‘í•  ê°ì²´ì˜ ë³€ìˆ˜ëª…
    â—¦ column : ë§¤í•‘í•  DB í…Œì´ë¸”ì˜ ì»¬ëŸ¼ëª…
<br>

### collection : ì»¬ë ‰ì…˜ ì†ì„±ì— ëŒ€í•œ ë§¤í•‘ ì •ë³´ë¥¼ ì§€ì •í•˜ëŠ” íƒœê·¸ <br>

```java
@Data
public class Users {
	 ...
   List<UserAuth> authList;

}
// ìœ„ì™€ ê°™ì´ í´ë˜ìŠ¤ì˜ ë©¤ë²„ë³€ìˆ˜ë¡œ ì»¬ë ‰ì…˜(ë¦¬ìŠ¤íŠ¸)ê°€ ìˆë‹¤ë©´, ì¡°ì¸ ì¿¼ë¦¬ ë“±ìœ¼ë¡œ 1:N ì˜ ë°ì´í„°ë¥¼ ë§¤í•‘í•  ìˆ˜ ìˆë‹¤.

<collection property="authList" resultMap="authMap"></collection>
```

### UserMapper.java ì†ì„± <br>
```java
@Mapper
public interface UserMapper {

    // ì‚¬ìš©ì ì¸ì¦(ë¡œê·¸ì¸) - id
    public Users login(String username);

}
```

<br>

### CustomUserDetailsService.java ì†ì„± <br>
```java
/**
 * UserDetailsService 
 * : Spring Securityì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì™€ì„œ,
 *   ì‚¬ìš©ì ì¸ì¦ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ì¸í„°í˜ì´ìŠ¤
 * * ìœ„ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬ loadUserByUsername() ì¬ì •ì˜í•˜ë©´,
 * * ë°ì´í„°ë² ì´ìŠ¤ë‚˜ ë‹¤ë¥¸ ì†ŒìŠ¤ë¡œë¶€í„° ì‚¬ìš©ì ì¸ì¦ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì— ì „ë‹¬í•´ì¤„ ìˆ˜ ìˆë‹¤.
 */
@Slf4j
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper;

    /**
     *  ì‚¬ìš©ì ì •ì˜ ì‚¬ìš©ì ì¸ì¦ ë©”ì†Œë“œ
     *  UserDetails
     *    â¡ Users
     *        â¬† CustomUser   
     */
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        log.info("userId : " + username);

        Users users = userMapper.login(username);
        log.info("users : " + users);
        CustomUser customUser = null;

        if( users != null ) 
            customUser = new CustomUser(users);
        
        return customUser;
    }
}

// ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ UserDetailsServiceë¥¼ êµ¬í˜„í•˜ì—¬ ì‚¬ìš©ì ìƒì„¸ ì •ë³´ë¥¼ ì–»ì–´ì˜¤ëŠ” ë©”ì„œë“œë¥¼ ì¬ì •ì˜í•œë‹¤. 
// ì´ ì‘ì—…ì„ í†µí•´, ë°ì´í„°ë² ì´ìŠ¤ë‚˜ ë‹¤ë¥¸ ì†ŒìŠ¤ë¡œë¶€í„° ì‚¬ìš©ì ì¸ì¦ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì— ì „ë‹¬í•´ì¤„ ìˆ˜ ìˆë‹¤.
```

### SecurityConfig.java ì†ì„± <br>

```java

@EnableWebSecurity              // í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì • ë¹ˆìœ¼ë¡œ ë“±ë¡
public class SecurityConfig extends WebSecurityConfigurerAdapter {

		@Autowired
    private PasswordEncoder passwordEncoder;        // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ê°ì²´

		@Autowired
    private DataSource dataSource;          // application.properites ì— ì •ì˜í•œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê°ì²´
		
		// ğŸ‘®â€â™‚ï¸ğŸ”ì‚¬ìš©ì ì¸ì¦ ê´€ë¦¬ ë©”ì†Œë“œ
		@Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {

        // ì¸ì¦ ë°©ì‹ : ì‚¬ìš©ì ì •ì˜ ì¸ì¦ (UserDetails)
        auth.userDetailsService( customUserDetailsService() )
            // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ë°©ì‹ ì§€ì • - BCryptPasswordEncoder ë˜ëŠ” NoOpPasswordEncoder
            .passwordEncoder( passwordEncoder );

		}


		// ì‚¬ìš©ì ì •ì˜ ì¸ì¦ êµ¬í˜„ í´ë˜ìŠ¤ - ë¹ˆ ë“±ë¡
    @Bean
    public UserDetailsService customUserDetailsService() {
        return new CustomUserDetailsService();
    }

}
// userDetailsService() ë©”ì†Œë“œì— ì‚¬ìš©ì ì •ì˜ ì¸ì¦ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ì§€ì •í•´ì£¼ê³  passwordEncoder ë¥¼ ì§€ì •í•´ì¤€ë‹¤.

```
<br>

### WebConfig.java ì†ì„± <br>

```java
@Configuration          // ë¹ˆ ë“±ë¡ ì„¤ì • í´ë˜ìŠ¤ ì§€ì •
public class WebConfig {

    @Bean                   // ë¹ˆ ë“±ë¡
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
        // return NoOpPasswordEncoder.getInstance();
        // BCryptPasswordEncoder        : BCrypt í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” 
        // NoOpPasswordEncoder          : ì•”í˜¸í™” ì—†ì´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì €ì¥
        // ...
    }
    
}
```

<br>
<hr>
<br>

### CSRF (Cross-Site Request Forgery) <br>

    ì„¸ì…˜ì˜ ë“±ë¡ëœ ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë‹¤ë¥¸ ì•…ì˜ì ì´ ì‚¬ì´íŠ¸ì—ì„œ íƒˆì·¨í•˜ì—¬, ì•…ì˜ì ì¸ ìš”ì²­ì„ í•˜ëŠ”ë°, ë§ˆì¹˜ ì¸ì¦ëœ ì‚¬ìš©ìê°€ ìš”ì²­ì„ ë³´ë‚¸ ê²ƒì²˜ëŸ¼ ìš”ì²­ì„ ìœ„ì¡°í•˜ëŠ” ì›¹ ë³´ì•ˆ ê³µê²©
<br>

### CSRF ê³µê²© ì›ë¦¬ <br>
    1. í¬ìƒìëŠ” ì€í–‰ ì›¹ ì‚¬ì´íŠ¸ì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì„¸ì…˜ í† í°(ì„¸ì…˜ ID)ì´ ìƒì„±ë©ë‹ˆë‹¤.
    2. í¬ìƒìëŠ” ì•…ì˜ì ì¸ ì›¹ ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•©ë‹ˆë‹¤. ì´ ì›¹ ì‚¬ì´íŠ¸ì—ëŠ” CSRF ê³µê²©ì„ ì‹¤í–‰í•˜ëŠ” ì•…ì˜ì ì¸ ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    3. í¬ìƒìê°€ ì•…ì˜ì ì¸ ì›¹ ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•˜ë©´, ì´ ì›¹ ì‚¬ì´íŠ¸ëŠ” ì€í–‰ ì›¹ ì‚¬ì´íŠ¸ë¡œ í¬ìƒì ëŒ€ì‹  ìš”ì²­ì„ ë³´ë‚´ë„ë¡ ë¸Œë¼ìš°ì €ë¥¼ ì¡°ì‘í•©ë‹ˆë‹¤. ì´ ìš”ì²­ì—ëŠ” í¬ìƒìì˜ ì¸ì¦ ì •ë³´(ì„¸ì…˜ í† í°)ì´ í¬í•¨ë©ë‹ˆë‹¤.
    4. ì€í–‰ ì›¹ ì‚¬ì´íŠ¸ëŠ” ë¸Œë¼ìš°ì €ë¡œë¶€í„° ë°›ì€ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³ , ì´ ìš”ì²­ì´ ìœ íš¨í•œ ê²ƒì²˜ëŸ¼ ì¸ì‹í•©ë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì€í–‰ ê³„ì¢Œ ì´ì²´ ë˜ëŠ” ë‹¤ë¥¸ ë¯¼ê°í•œ ì‘ì—…ì´ ì´ë£¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<br>

### CSRF ë°©ì–´ <br>
    ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ CSRF ë°©ì§€ ê¸°ëŠ¥ì´ í™œì„±í™” ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

    CSRF ê³µê²© ì›ë¦¬ì—ì„œ ì•Œ ìˆ˜ ìˆë“¯ì´, CSRF ê³µê²©ì€ ì‚¬ì´íŠ¸ê°„ ìš”ì²­ ìœ„ì¡°ë¥¼ í†µí•´ ë°œìƒí•˜ëŠ” ì›¹ ë³´ì•ˆ ê³µê²©ì…ë‹ˆë‹¤. ë”°ë¼ì„œ, CSRF ê³µê²©ì„ ë°©ì–´ í•˜ê¸° ìœ„í•´ì„œëŠ” í•´ë‹¹ ìš”ì²­ì´ íƒ€ ì‚¬ì´íŠ¸ì—ì„œì˜ ìš”ì²­ì´ ì•„ë‹ˆë¼, í˜„ì¬ ì‚¬ì´íŠ¸ì™€ ì—°ê²°ëœ ìœ íš¨í•œ ìš”ì²­ì´ë¼ëŠ” ê²ƒì„ í™•ì¸í•´ì•¼í•©ë‹ˆë‹¤.

    ì´ë¥¼ ìœ„í•´ì„œ, ì„œë²„ ì¸¡ì—ì„œ ì‘ë‹µí•œ ë·°(html) ë¥¼ í†µí•´ ìš”ì²­í•œ ê²ƒì¸ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ, ì„œë²„ëŠ” CSRF í† í°ì„ ë°œí–‰í•©ë‹ˆë‹¤. ì´ CSRF í† í°ì„ ì „ë‹¬ ë°›ì€ í´ë¼ì´ì–¸íŠ¸ê°€ ë‹¤ìŒ ìš”ì²­ ì‹œì— CSRF í† í°ê³¼ í•¨ê»˜ ìš”ì²­ì„ ë³´ë‚´ë©´ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ì´ë¥¼ ì¸ì‹í•˜ì—¬ ìœ íš¨í•œ ìš”ì²­ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.

    ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì˜ì¡´ì„±ì„ í¬í•¨í•œ í›„, POST ë°©ì‹ìœ¼ë¡œ Form ìš”ì²­ì„ ë³´ë‚´ë©´ 403 Forbidden ìƒíƒœì½”ë“œë¥¼ ì‘ë‹µë°›ê²Œ ë©ë‹ˆë‹¤. 403 ìƒíƒœì½”ë“œëŠ” ì„œë²„ì˜ ìì›ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ì–´ ìš”ì²­ì´ ê±°ë¶€ë˜ì—ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” ìƒíƒœì½”ë“œ ì…ë‹ˆë‹¤.  ì´ë ‡ê²Œ ì‘ë‹µë˜ëŠ” ì´ìœ ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì— CSRF ë°©ì§€ ê¸°ëŠ¥ì´ ê¸°ë³¸ìœ¼ë¡œ í™œì„±í™” ë˜ì–´ ìˆê³ , ìœ íš¨í•œ ìš”ì²­ì„ ì¦ëª…í•˜ê¸° ìœ„í•œ CSRF í† í°ê³¼ í•¨ê»˜ ìš”ì²­í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

    ë”°ë¼ì„œ, ìŠ¤í”„ë§ ì‹œíë¦¬í‹° CSRF ë°©ì§€ ê¸°ëŠ¥ì´ í™œì„±í™” ë˜ì–´ìˆëŠ” ìƒíƒœì—ì„œ ìš”ì²­ì„ ë³´ë‚¼ ë•Œì—ëŠ”, í•­ìƒ CSRF í† í°ì„ í¬í•¨í•˜ì—¬ ìš”ì²­ì„ í•´ì•¼í•©ë‹ˆë‹¤.
<br>

### CSRF Token <br>
```html
<!-- CSRF í† í° -->
<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
```
<br>

### CSRF Token ì„ Form ì— í¬í•¨í•œ ì˜ˆì‹œ <br>
```html
<form method="post" action="/submit">
    <!-- CSRF í† í° -->
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />

    <!-- ë‹¤ë¥¸ ì…ë ¥ í•„ë“œë“¤ -->
    <input type="text" name="username" />
    <input type="password" name="password" />

    <button type="submit">ë¡œê·¸ì¸</button>
</form>
```
Thymeleaf í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, Spring SecurityëŠ” ìë™ìœ¼ë¡œ CSRF í† í°ì„ Formì— ì‚½ì…í•©ë‹ˆë‹¤.

<br>

### SecurityConfig.java ì†ì„±

```java

@EnableWebSecurity              // í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì • ë¹ˆìœ¼ë¡œ ë“±ë¡
public class SecurityConfig extends WebSecurityConfigurerAdapter {

		@Autowired
    private PasswordEncoder passwordEncoder;        // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ê°ì²´
		
		// ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì • ë©”ì†Œë“œ
		@Override
    protected void configure(HttpSecurity http) throws Exception {

       // CSRF ë°©ì§€ ê¸°ëŠ¥ ë¹„í™œì„±í™” ì„¤ì •
       http.csrf().disable();

		}

}
//  CSRF ë°©ì§€ ê¸°ëŠ¥ì€ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™” ë˜ì–´ ìˆê³ , ê°œë°œ ëª¨ë“œì—ì„œ ë¹„í™œì„±í™”í•˜ê³  ì‹¶ë‹¤ë©´,  http.csrf().disable(); ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ë¹„í™œì„±í™” í•  ìˆ˜ ìˆë‹¤.
```

<br>
<hr>
<br>

### ìë™ ë¡œê·¸ì¸ - RememberMe <br>
    ë¡œê·¸ì¸ ì‹œ, ìë™ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì— ì „ë‹¬í•˜ê³ , ì„¸ì…˜(ë¸Œë¼ìš°ì €) ì¢…ë£Œ í›„ ë‹¤ì‹œ ì ‘ì†í•  ë•Œ, ì¿ í‚¤ì— ì €ì¥ëœ ì¸ì¦ í† í°ì„ ì´ìš©í•´ì„œ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ persistent_logins í…Œì´ë¸”ê³¼ ì¸ì¦í† í°ì„ ë§¤ì¹­í•˜ì—¬ ì‚¬ìš©ì ì¸ì¦ì„ ìë™ìœ¼ë¡œ í•´ì£¼ëŠ” ê¸°ëŠ¥

    â€¢ ìë™ ë¡œê·¸ì¸ í…Œì´ë¸” ì •ì˜ - persistent_logins

    â€¢ PersistentRepository í† í° ì •ë³´ ê°ì²´ ë¹ˆ ë“±ë¡
    
    â€¢ ìë™ ë¡œê·¸ì¸ ì„¤ì • - rememberMe
    
    â€¢ Form ìš”ì²­  remeber-me ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ í¬í•¨í•˜ì—¬ ë¡œê·¸ì¸
<br>

```sql
create table persistent_logins (
	  username varchar(64) not null
	, series varchar(64) primary key
	, token varchar(64) not null
	, last_used timestamp not null)
;
```
<br> 

### ìë™ ë¡œê·¸ì¸ ì„¤ì • - rememberMe <br>
â€¢ PersistentRepository í† í°ì •ë³´ ê°ì²´ ë¹ˆ ë“±ë¡

â€¢ SecurityConfig.java

```java

@EnableWebSecurity              // í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì • ë¹ˆìœ¼ë¡œ ë“±ë¡
public class SecurityConfig extends WebSecurityConfigurerAdapter {

		@Autowired
    private PasswordEncoder passwordEncoder;        // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ê°ì²´

		@Autowired
    private DataSource dataSource;          // application.properites ì— ì •ì˜í•œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê°ì²´
		
		// ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì • ë©”ì†Œë“œ
		@Override
    protected void configure(HttpSecurity http) throws Exception {

				// ìë™ë¡œê·¸ì¸ ì„¤ì •
        http.rememberMe()
            .key("joeun")
            // DataSource ê°€ ë“±ë¡ëœ PersistentRepository í† í°ì •ë³´ ê°ì²´ 
            .tokenRepository( tokenRepository() )
            // í† í° ìœ íš¨ê¸°ê°„ ì§€ì • : 7ì¼ (ì´ˆ ë‹¨ìœ„)
            .tokenValiditySeconds( 60 * 60 * 24 * 7 )                    
            ;

		}


		// PersistentRepository í† í°ì •ë³´ ê°ì²´ - ë¹ˆ ë“±ë¡
    @Bean
    public PersistentTokenRepository tokenRepository() {
        // JdbcTokenRepositoryImpl : í† í° ì €ì¥ ë°ì´í„° ë² ì´ìŠ¤ë¥¼ ë“±ë¡í•˜ëŠ” ê°ì²´
        JdbcTokenRepositoryImpl repositoryImpl = new JdbcTokenRepositoryImpl(); 
        repositoryImpl.setDataSource(dataSource);   // í† í° ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ëŠ” ë°ì´í„° ì†ŒìŠ¤ ì§€ì •
        return repositoryImpl;
    }

}
```

<br>

### Form ìš”ì²­  remeber-me ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ í¬í•¨í•˜ì—¬ ë¡œê·¸ì¸ <br>

â€¢ login.html
```html
<form action="/login" method="post">
		<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

		<input type="text" name="username" placeholder="ì•„ì´ë””"> <br>
		<input type="password" name="pw" placeholder="ë¹„ë°€ë²ˆí˜¸"> <br>

		<!-- ìë™ë¡œê·¸ì¸(Remember-Md) ê¸°ëŠ¥ -->
    <!-- remember-me ìš”ì²­ íŒŒë¼ë¯¸í„°ë¡œ ìë™ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ì „ë‹¬ -->
    <input type="checkbox" name="remember-me" id="remember-me">
    <label for="remember-me">ìë™ ë¡œê·¸ì¸</label> <br>
</form>

<!-- ì•„ë˜ì˜ remember-me ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ í¬í•¨í•˜ì—¬ ë¡œê·¸ì¸ ìš”ì²­ì„ ë³´ë‚¸ë‹¤. -->
<input type="checkbox" name="remember-me" id="remember-me">
```