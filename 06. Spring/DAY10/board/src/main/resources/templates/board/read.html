<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ì¡°íšŒ</title>
    <style>
        .reply-box.answer {
            margin-left: 40px;
        }

        .reply-box .inner {
            min-width: 500px;
            max-width: 100vw;
            padding: 20px;
            border: 1px solid black;
        }

        .reply-box .top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>ê²Œì‹œê¸€ ì¡°íšŒ</h1>
    <form action="/board/delete" method="POST">
        <input type="hidden" name="no" th:value="${board.no}" />
        <table border="1">
            <tr>
                <td><label for="title">ì œëª©</label></td>
                <td><input type="text" name="title" th:value="${board.title}" /></td>
            </tr>
            <tr>
                <td><label for="writer">ì‘ì„±ì</label></td>
                <td><input type="text" name="writer" th:value="${board.writer}" /></td>
            </tr>
            <tr>
                <td><label for="content">ë‚´ìš©</label></td>
                <td>
                    <textarea rows="5" cols="22" name="content" th:text="${board.content}"></textarea>
                </td>
            </tr>
            <tr>
                <td>íŒŒì¼</td>
                <td>
                    <ul>
                        <!-- íŒŒì¼ ëª©ë¡ -->
                        <th:block th:each="file : ${fileList}">
                            <li>
                                <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ -->
                                <img th:src="|/file/img/${file.no}|" alt="ì¸ë„¤ì¼" width="200">
                                <!-- íŒŒì¼ëª… (ë‹¤ìš´ë¡œë“œ) -->
                                <a th:href="|/file/${file.no}|" th:text="${file.originName}"></a>
                                <!-- íŒŒì¼ ì‚­ì œ -->
                                <button type="button" th:onclick="|deleteFile(this, ${file.no})|">ì‚­ì œ</button>
                            </li>
                        </th:block>
                    </ul>
                </td>
            </tr>
        </table>
        <div>
            <button type="button" onclick="moveUpdate()">ìˆ˜ì •</button>
            <button type="button" onclick="moveList()">ëª©ë¡</button>
        </div>
    </form>

    <!-- ëŒ“ê¸€ ì…ë ¥ -->
    <div id="reply-input">
        <h3>ëŒ“ê¸€</h3>
        <div class="reply-input">
            <input type="text" name="writer" id="reply-writer" class="reply-writer"
                    placeholder="ì‘ì„±ì">
            <br>
            <textarea name="content" id="reply-content" cols="60" rows="5"
                    placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
            <div class="btn-box">
                <button type="button" id="btn-reply-insert" class="btn-reply"
                        onclick="insertReply()">ë“±ë¡</button>
            </div>
        </div>
    </div>

    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <div id="reply-list">

    </div>

    <script>

        // ğŸ‘©â€ğŸ’» ëª¨ë¸ ê°ì²´ë¥¼ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•
        let no = "[[${board.no}]]"          // ê¸€ë²ˆí˜¸

        // ëŒ“ê¸€ ëª©ë¡ ìš”ì²­
        replyList()
        
        // ìˆ˜ì • í™”ë©´ ì´ë™
        function moveUpdate() {
            location.href = '/board/update?no=' + no
        }

        // ëª©ë¡ í™”ë©´ ì´ë™
        function moveList() {
            location.href = '/board/list'
        }

        // íŒŒì¼ ì‚­ì œ
        function deleteFile(element, no) {
            // alert(no)

            // AJAX ë¹„ë™ê¸° ìš”ì²­
            let request = new XMLHttpRequest()

            // request.open(ìš”ì²­ë©”ì†Œë“œ, URL)
            request.open('DELETE', '/file/' + no)
            request.send()

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µ ì‹œ,
                if( request.readyState == request.DONE && request.status == 200 ) {
                    console.log("íŒŒì¼ ì‚­ì œ ì„±ê³µ!");
                    // íŒŒì¼ í•­ëª© ì œê±°
                    element.parentNode.remove()
                }
            }
        }

        // ëŒ“ê¸€ ëª©ë¡
        function replyList() {
            // AJAX ë¹„ë™ê¸° ìš”ì²­
            let request = new XMLHttpRequest()

            // request.open(ìš”ì²­ë©”ì†Œë“œ, URL)
            request.open('GET', '/reply/' + no) // no : ê¸€ë²ˆí˜¸
            request.send()

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µ ì‹œ,
                if( request.readyState == request.DONE && request.status == 200 ) {
                    // ëŒ“ê¸€ ëª©ë¡
                    let response = request.responseText

                    // â­ ì„œë²„ì—ì„œ ë Œë”ë§í•œ HTMLë¡œ ê°±ì‹  (SSR)
                    let data = response     // (html)

                    // â­ JSON ë°ì´í„°ë¥¼ ì „ë‹¬ë°›ì•„ HTML ë¡œ ë³€í™˜ (CSR)
                    // let replyListData = JSON.parse(response)    // JSON -> array

                    // let data =`` 
                    // for(let i = 0 ; i < replyListData.length ; i++) {
                    //     data += `<div class="reply-box">`
                    //     data += `<div class="inner">`
                        
                    //     data += `<div class="top">`
                    //     let writer = replyListData[i].writer        // ì‘ì„±ì
                    //     let content = replyListData[i].content      // ëŒ“ê¸€ë‚´ìš©
                    //     let date = replyListData[i].regDate         // ë“±ë¡ì¼ì
                        
                    //     data += `<span class = "reply-writer">${writer}</span>`
                    //     data += `<span class = "reply-date">${date}</span>`
                        
                    //     data += `<div class="item">`
                    //     data += `<button class="btn-reply-update">ìˆ˜ì •</button>`
                    //     data += `<button class="btn-reply-delete">ì‚­ì œ</button>`
                    //     data += `</div>`
                    //     data += `</div>`

                    //     data += `<p class="reply-content">${content}</p>`
                    //     data += `<button class="btn-reply-answer">ë‹µê¸€</button>`
                        
                    //     data += `</div>`
                    //     data += `</div>`
                    // }

                    let replyList = document.getElementById('reply-list')
                    replyList.innerHTML = data

                    // ì´ë²¤íŠ¸ ë“±ë¡
                    event()
                }
            }
        }

        // ëŒ“ê¸€ ë“±ë¡
        function insertReply() {
            let $writer = document.getElementById('reply-writer')
            let $content = document.getElementById('reply-content')
            
            let writer = $writer.value
            let content = $content.value

            let data = {
                'boardNo' : no,
                'writer'  : writer,
                'content' : content
            }

            let request = new XMLHttpRequest()
            
            request.open('POST', '/reply')
            request.setRequestHeader('Content-Type', 'application/json')
            request.send( JSON.stringify(data) )

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µ ì‹œ,
                if( request.readyState == request.DONE && request.status == 201 ) {
                    console.log("ëŒ“ê¸€ ë“±ë¡ ì„±ê³µ!");
                    // alert(request.responseText)         // ì‘ë‹µ ë©”ì‹œì§€ í™•ì¸
                    let response = request.responseText
                    if( response == 'SUCCESS') {
                        replyList()     // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
                        // ëŒ“ê¸€ ì…ë ¥ ì°½ ë¹„ìš°ê¸°
                        $writer.value = ''
                        $content.value = ''
                    }
                }
            }
        }

        function event() {
            // ëŒ“ê¸€ ìˆ˜ì • í´ë¦­
            let $btnUpdate = document.getElementsByClassName('btn-reply-update')
            // ëŒ“ê¸€ ì‚­ì œ í´ë¦­
            let $btnDelete = document.getElementsByClassName('btn-reply-delete')

            // ëŒ“ê¸€ ìˆ˜ì • í´ë¦­ ì´ë²¤íŠ¸
            for( let i = 0 ; i < $btnUpdate.length ; i++ ) {
                $btnUpdate[i].addEventListener('click', function() {
                    // alert('ìˆ˜ì • í´ë¦­')
                    // í•´ë‹¹ ëŒ“ê¸€ì˜ ì‘ì„±ì, ë‚´ìš©ì„ ê°€ì ¸ì˜¤ê¸°
                    // $btnUpdate[i] : í˜„ì¬ìš”ì†Œ (ìˆ˜ì • ë²„íŠ¼)
                    // ë¶€ëª¨ìš”ì†Œ                 : parentNode
                    // ë¶€ëª¨ìš”ì†Œ -> ë¶€ëª¨ìš”ì†Œ 
                    // ìì‹ìš”ì†Œ (reply-writer)  : childNodes[?], children
                    let $top = $btnUpdate[i].parentNode.parentNode
                    let writer = $top.childNodes[1].textContent
                    let $inner = $top.parentNode
                    let content = $inner.childNodes[3].textContent
                    let $replyBox = $inner.parentNode
                    
                    let no = $btnUpdate[i].getAttribute('data');

                    console.log(`ì‘ì„±ì : ${writer}`)
                    console.log(`ë‚´ìš© : ${content}`)
                    
                    // ëŒ“ê¸€ ìˆ˜ì • ëª¨ë“œ
                    // 1. ê¸°ì¡´ ëŒ“ê¸€ ë‚´ìš©ì°½ ìˆ¨ê¸°ê¸°
                    $inner.style.display = 'none'
                    // 2. ìˆ˜ì • UI ì¶œë ¥
                    let $editor = document.createElement('div')
                    $editor.classList.add('inner')
                    $editor.id = 'editor'
                    let editor = ``
                    // editor += `<div class="inner" id="editor">`
                    editor += `<input type="text" value="${writer}" id="update-writer"/>`
                    editor += `<br>`
                    editor += `<textarea cols="60" rows="5" id="update-content">${content}</textarea>`
                    editor += `<br>`
                    editor += `<button onclick="updateReply(${no})">ìˆ˜ì •</button>`
                    editor += `<button onclick="cancelReply()">ì·¨ì†Œ</button>`
                    // editor += `</div>`
                    $editor.innerHTML = editor
                    $replyBox.appendChild($editor)
                    // $replyBox.innerHTML = $replyBox.innerHTML + editor
                })
            }
            
            // for(let i = 0; i < $btnDelete.length; i++) {
                
            //     $btnDelete[i].addEventListener('click', function() {
            //         let no = $btnDelete[i].getAttribute('data');
            //         // alert(`ì‚­ì œ ã…‹ + ${no}`);
            //         deleteReply(no);
            //     });
            // }
        }

        // ëŒ“ê¸€ ìˆ˜ì • ìš”ì²­
        function updateReply(no) {
            let writer = document.getElementById('update-writer').value;
            let content = document.getElementById('update-content').value;

            var data = {
                'no': no,
                'writer': writer,
                'content': content
            };

            // ìˆ˜ì • ìš”ì²­
            // XMLHttpRequest ê°ì²´ ìƒì„±
            let request = new XMLHttpRequest();
            request.open('PUT', '/reply');
            request.setRequestHeader("Content-Type", "application/json")
            // ìš”ì²­ ì „ì†¡: JSON ë¬¸ìì—´ë¡œ ë³€í™˜ëœ ë°ì´í„°ë¥¼ í•¨ê»˜ ë³´ëƒ„
            request.send(JSON.stringify(data));

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µ ì‹œ,
                if( request.readyState == request.DONE && request.status == 200 ) {
                    console.log("ëŒ“ê¸€ ìˆ˜ì • ì„±ê³µ!");
                    // alert(request.responseText)         // ì‘ë‹µ ë©”ì‹œì§€ í™•ì¸
                    let response = request.responseText
                    if( response == 'SUCCESS') {
                        replyList()     // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
                    }
                }
            }
        }

        // ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ
        function cancelReply() {
            let $editor = document.getElementById('editor');
            $editor.remove()

            let $inner = document.getElementsByClassName('inner')
            for(let i = 0; i < $inner.length; i++) {
                $inner[i].style.display = 'block';
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ ìš”ì²­
        function deleteReply(no) {

            const check = confirm("ì •ë§ë¡œ ì‚­ì œí•˜ê² ìŠµë‹ˆê¹Œ?");

            if(!check || no === null) {
                return;
            }

            // ì‚­ì œ ìš”ì²­
            // XMLHttpRequest ê°ì²´ ìƒì„±
            let request = new XMLHttpRequest();

            request.open('DELETE', '/reply/' + no) // no : ê¸€ë²ˆí˜¸
            request.send();

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µ ì‹œ,
                if( request.readyState == request.DONE && request.status == 200 ) {
                    console.log("ëŒ“ê¸€ ì‚­ì œ ì„±ê³µ!");
                    // alert(request.responseText)         // ì‘ë‹µ ë©”ì‹œì§€ í™•ì¸
                    let response = request.responseText
                    if( response == 'SUCCESS') {
                        replyList()     // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
                    }
                }
            }
        }

        // ë‹µê¸€ ë“±ë¡ í•¨ìˆ˜
        function insertAnswer(element, no) {
            let $replyBox = element.parentNode.parentNode;
            console.log(`ë¶€ëª¨ ë²ˆí˜¸ : ${no}`);
            console.log($replyBox);

            // ë‹µê¸€ ì‘ì„± UI
            let $editor = document.createElement('div');
            $editor.classList.add('reply-box');
            $editor.id = 'answer';
            // <div id="answer" class="reply-box">
            let editor = ``;
            editor += `<div class="inner">`;
            editor += `<input type="text" id="answer-writer" />`;
            editor += `<br>`;
            editor += `<textarea cols="60" rows="5" id="answer-content"></textarea>`
            editor += `<br>`;
            editor += `<button onclick="answer(${no})">ë“±ë¡</button>`;
            editor += `<button onclick="cancelAnswer()">ì·¨ì†Œ</button>`;
            editor += `</div>`;
            $editor.innerHTML = editor;
            
            // ê¸°ì¡´ ë‹µê¸€ UIê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™”
            let $answer = document.getElementById("answer");
            if($answer) {
                $answer.parentNode.removeChild($answer);
            }

            // ìš”ì†Œ.after(ìƒˆ ìš”ì†Œ)
            // - ìš”ì†Œ ë°”ë¡œ ë’¤ì— ìƒˆ ìš”ì†Œë¥¼ ì¶”ê°€í•œë‹¤.
            $replyBox.after($editor);
        }
        
        // ë‹µê¸€ ë“±ë¡ ìš”ì²­
        function answer(parentNo) {
            // TODO: 
            // 1. answer-writer, answer-content ê°’ì„ ê°€ì ¸ì˜¤ê³ 
            let writer = document.getElementById('answer-writer').value;
            let content = document.getElementById('answer-content').value;
            console.log(`${no}`); 
            console.log(writer);
            
            // 2. data = { ë¶€ëª¨ ë²ˆí˜¸, ì‘ì„±ì, ë‚´ìš© }
            var data = {
                'boardNo'   : no,
                'parentNo'  : parentNo,
                'writer'    : writer,
                'content'   : content
            };
            
            // 3. POST - /reply ê²½ë¡œë¡œ ìš”ì²­
            //  ë‹µê¸€ ë“±ë¡ ìš”ì²­
            // XMLHttpRequest ê°ì²´ ìƒì„±
            let request = new XMLHttpRequest();
            request.open('POST', '/reply');
            request.setRequestHeader("Content-Type", "application/json")
            // ìš”ì²­ ì „ì†¡: JSON ë¬¸ìì—´ë¡œ ë³€í™˜ëœ ë°ì´í„°ë¥¼ í•¨ê»˜ ë³´ëƒ„
            request.send(JSON.stringify(data));

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µ ì‹œ,
                if( request.readyState == request.DONE && request.status == 201 ) {
                    console.log("ë‹µê¸€ ë“±ë¡ ì„±ê³µ!");
                    alert(request.responseText)         // ì‘ë‹µ ë©”ì‹œì§€ í™•ì¸
                    let response = request.responseText
                    if( response == 'SUCCESS') {
                        replyList()     // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
                        // ëŒ“ê¸€ ì…ë ¥ ì°½ ë¹„ìš°ê¸°
                        writer.value = ''
                        content.value = ''
                    }
                }
            }
        }

        // ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ
        function cancelAnswer() {
            // ê¸°ì¡´ ë‹µê¸€ UIê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™”
            let $answer = document.getElementById("answer");
            if($answer) {
                $answer.parentNode.removeChild($answer);
            }
        }
    </script>
</body>
</html>